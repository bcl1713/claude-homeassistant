name: Daily Upstream Sync

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§ Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use the PAT for checkout/push later, though default GITHUB_TOKEN works for checkout
          token: ${{ secrets.UPSTREAM_SYNC_TOKEN }}

      - name: â¬†ï¸ Add Upstream Remote
        run: |
          # Replace 'upstream-user/upstream-repo' with the actual upstream repo path
          git remote add upstream https://github.com/philippb/claude-homeassistant.git

      - name: ğŸ“¥ Fetch Upstream Changes
        run: |
          git fetch upstream

      - name: ğŸ”„ Attempt Merge and Push
        id: merge_attempt
        run: |
          UPSTREAM_BRANCH="main" 
          LOCAL_BRANCH="main"    

          if git merge --ff-only upstream/$UPSTREAM_BRANCH -m "chore(sync): Sync with upstream $UPSTREAM_BRANCH"; then
            echo "Clean fast-forward merge successful. Pushing changes."
            git push origin $LOCAL_BRANCH
            echo "Push complete."
            echo "merge_status=success" >> $GITHUB_OUTPUT # Set output variable
          else
            echo "Merge conflict detected or fast-forward not possible. Setting output for issue creation."
            echo "merge_status=failure" >> $GITHUB_OUTPUT # Set output variable
            exit 0 # Exit successfully so the next steps run, but they'll check the output
          fi

      - name: ğŸ“ Create Issue on Merge Failure
        # Only runs if the previous step's output was 'failure'
        if: steps.merge_attempt.outputs.merge_status == 'failure'
        uses: peter-evans/create-or-update-issue@v4
        with:
          # Use the default GITHUB_TOKEN for creating the issue (it has permission)
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸš¨ Upstream Sync Failed: Manual Merge Required"
          body: |
            The daily sync from the upstream branch (`main`) failed to perform a clean fast-forward merge into the local branch (`main`).

            **Manual intervention is required.**

            Please resolve the conflicts and update the local branch. The upstream remote is aliased as `upstream`.

            * **Upstream:** `upstream/main`
            * **Local:** `main`
          labels: |
            bug
            sync-failure
