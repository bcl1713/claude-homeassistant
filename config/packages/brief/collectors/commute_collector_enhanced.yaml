# packages/brief/collectors/commute_collector_enhanced.yaml
#
# Enhanced Commute Collector - Phase 3 with Entity Validation
# Validates travel time sensors exist, graceful degradation
# Based on: https://www.home-assistant.io/docs/scripts/
#
# Last Updated: 2025-11-07

script:
  brief_collect_commute_safe:
    alias: "Collect Commute (Safe with Validation)"
    description: "Gathers commute data with entity validation and graceful fallback"
    mode: parallel
    fields:
      timeout_seconds:
        description: "Timeout for collection (from config_loader)"
        default: 15
        selector:
          number:
            min: 1
            max: 60
    variables:
      # MQTT topic for publishing data
      mqtt_topic: "home/brief/data/commute"
      fallback_payload: "Travel times unavailable"

      # Time context
      is_weekday: "{{ now().weekday() < 5 }}"
      is_morning: "{{ now().hour < 12 }}"
      is_relevant: "{{ is_weekday and is_morning }}"

      # Check if travel time sensors exist (both optional)
      has_brian_time: "{{ states('sensor.travel_time_to_brian_s_work') not in ['unknown', 'unavailable'] }}"
      has_hester_time: "{{ states('sensor.travel_time_to_hester_s_work') not in ['unknown', 'unavailable'] }}"

      # Build list of available/missing entities
      available_entities: >
        {%- set available = [] -%}
        {%- if has_brian_time -%}
          {%- set available = available + ['sensor.travel_time_to_brian_s_work'] -%}
        {%- endif -%}
        {%- if has_hester_time -%}
          {%- set available = available + ['sensor.travel_time_to_hester_s_work'] -%}
        {%- endif -%}
        {{ available }}

      missing_entities: >
        {%- set missing = [] -%}
        {%- if not has_brian_time -%}
          {%- set missing = missing + ['sensor.travel_time_to_brian_s_work'] -%}
        {%- endif -%}
        {%- if not has_hester_time -%}
          {%- set missing = missing + ['sensor.travel_time_to_hester_s_work'] -%}
        {%- endif -%}
        {{ missing }}

      # Commute is only relevant weekday mornings
      has_data_when_relevant: "{{ is_relevant and (has_brian_time or has_hester_time) }}"

    sequence:
      # Collect commute data - always runs when called by orchestration
      - if:
          - condition: template
            value_template: "{{ is_relevant }}"
        then:
          # It's a weekday morning - collect commute data
          - if:
              - condition: template
                value_template: "{{ has_brian_time or has_hester_time }}"
            then:
              # At least one travel time sensor available - collect what we have
              - variables:
                  brian_time: >
                    {%- if has_brian_time -%}
                      {{ states('sensor.travel_time_to_brian_s_work') }}
                    {%- else -%}
                      N/A
                    {%- endif -%}
                  hester_time: >
                    {%- if has_hester_time -%}
                      {{ states('sensor.travel_time_to_hester_s_work') }}
                    {%- else -%}
                      N/A
                    {%- endif -%}

              - variables:
                  commute_data:
                    relevant: true
                    time_context: "weekday_morning"
                    brian_time: "{{ brian_time }}"
                    hester_time: "{{ hester_time }}"
                    available_sensors: "{{ available_entities }}"
                    missing_sensors: "{{ missing_entities }}"
                    validation_status: >
                      {%- if missing_entities | length > 0 -%}
                        partial
                      {%- else -%}
                        success
                      {%- endif -%}

              - service: mqtt.publish
                data:
                  topic: "{{ mqtt_topic }}"
                  payload: "{{ commute_data | tojson }}"

            else:
              # No travel time sensors available - publish error
              - variables:
                  commute_data:
                    relevant: true
                    time_context: "weekday_morning"
                    brian_time: "N/A"
                    hester_time: "N/A"
                    available_sensors: []
                    missing_sensors: "{{ missing_entities }}"
                    validation_status: "failed"
                    error_message: "No travel time sensors available"
                    fallback_message: "{{ fallback_payload }}"

              - service: mqtt.publish
                data:
                  topic: "{{ mqtt_topic }}"
                  payload: "{{ commute_data | tojson }}"

              # Log validation error
              - service: mqtt.publish
                data:
                  topic: "home/brief/validation/commute"
                  payload: >
                    {{
                      {
                        "timestamp": now().isoformat(),
                        "status": "validation_error",
                        "missing_entities": missing_entities,
                        "help": "Add travel time sensors in Waze integration"
                      } | tojson
                    }}

        else:
          # Not a weekday morning - collect but mark as not relevant
          - variables:
              commute_data:
                relevant: false
                time_context: >
                  {%- if now().weekday() >= 5 -%}
                    weekend
                  {%- else -%}
                    evening
                  {%- endif -%}
                brian_time: "N/A"
                hester_time: "N/A"
                reason: "Commute not relevant at this time"
                validation_status: "success"

          - service: mqtt.publish
            data:
              topic: "{{ mqtt_topic }}"
              payload: "{{ commute_data | tojson }}"
